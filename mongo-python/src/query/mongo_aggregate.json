[
    {
       "$match":{
          "$and":[
             {
                "topLevelFilter.id":{
                   "$in":[
                      "5fd1bd7868d7ac4e211a7642", "5feb61f0358689f9bf99ff08", "5fd1bd7868d7ac4e211a7642"
                   ]
                }
             },
             {
                "ruleCategory":{
                   "$nin":[
                      "",
                      null
                   ]
                }
             }
          ]
       }
    },
    {
       "$group":{
          "_id":{
             "ruleCategory":"$ruleCategory",
             "topLevelFilter":"$topLevelFilter.id"
          },
          "name":{
             "$first":"$topLevelFilter.name"
          },
          "type":{
             "$first":"$topLevelFilter.type"
          },
          "fail":{
             "$sum":{
                "$cond":[
                   {
                      "$eq":[
                         "$summaryStatus",
                         0
                      ]
                   },
                   1,
                   0
                ]
             }
          },
          "pass":{
             "$sum":{
                "$cond":[
                   {
                      "$eq":[
                         "$summaryStatus",
                         1
                      ]
                   },
                   1,
                   0
                ]
             }
          },
          "warn":{
             "$sum":{
                "$cond":[
                   {
                      "$eq":[
                         "$summaryStatus",
                         2
                      ]
                   },
                   1,
                   0
                ]
             }
          }
       }
    },
    {
       "$group":{
          "_id":"$_id.ruleCategory",
          "fail":{
             "$sum":"$fail"
          },
          "pass":{
             "$sum":"$pass"
          },
          "warn":{
             "$sum":"$warn"
          },
          "portfolio":{
             "$push":{
                "id":"$_id.topLevelFilter",
                "name":"$name",
                "type":"$type",
                "fail":"$fail",
                "pass":"$pass",
                "warn":"$warn"
             }
          }
       }
    },
    {
       "$group":{
          "_id":0,
          "result":{
             "$push":{
                "category":"$_id",
                "fail":"$fail",
                "pass":"$pass",
                "warn":"$warn",
                "portfolio":"$portfolio"
             }
          },
          "fail":{
             "$sum":"$fail"
          },
          "pass":{
             "$sum":"$pass"
          },
          "warn":{
             "$sum":"$warn"
          }
       }
    },
    {
       "$project":{
          "_id":0,
          "data":"$result",
          "total":{
             "fail":"$fail",
             "pass":"$pass",
             "warn":"$warn"
          }
       }
    }
 ]

 